apiVersion: batch/v1
kind: CronJob
metadata:
  name: monthly-settlement-cronjob
  labels:
    app: batch-service
    component: cronjob
    job-type: monthly-settlement
spec:
  schedule: "30 0 1 * *"
  timeZone: "Asia/Seoul"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 600  # 월별 작업은 시작 지연 허용치를 높임
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 60분 제한 (대량 데이터 처리)
      template:
        metadata:
          labels:
            app: batch-service
            job-type: monthly-settlement
        spec:
          restartPolicy: OnFailure
          containers:
          - name: batch-job
            image: minbros/batch:latest
            imagePullPolicy: Always
            env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            - name: TZ
              value: "Asia/Seoul"
            - name: SPRING_BATCH_JOB_NAME
              value: "settlementWithdrawalJob"
            - name: JOB_DESCRIPTION
              value: "월별 정산 작업"
            - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
              value: "kafka-service:9092"
            - name: ELASTICSEARCH_URIS
              value: "http://elasticsearch-service:9200"
            - name: CLIENT_MEMBER
              value: "http://member-service:8083"
            - name: CLIENT_COMMERCE
              value: "http://commerce-service:8087"
            envFrom:
              - secretRef:
                  name: batch-secret
            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
                ephemeral-storage: "512Mi"
              limits:
                memory: "512Mi"
                cpu: "500m"
                ephemeral-storage: "1Gi"
