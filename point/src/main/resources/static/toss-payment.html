<!DOCTYPE html>
<!--suppress ALL -->
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Toss Payment Demo</title>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2rem;
        }

        #payment-method {
            margin-top: 1rem;
            border: 1px solid #e0e0e0;
            padding: 1rem;
        }

        button {
            margin-top: 1.5rem;
            padding: 0.75rem 1.5rem;
            background-color: #3182f6;
            color: white;
            border: none;
            cursor: pointer;
        }

        input {
            padding: 0.4rem;
            margin-top: 0.3rem;
        }
    </style>
</head>
<body>
<h1>Toss ê²°ì œ í…ŒìŠ¤íŠ¸</h1>
<p>ê²°ì œ ê¸ˆì•¡ì„ ì…ë ¥í•œ í›„ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
<pre id="result"></pre>

<label>
    ê²°ì œ ê¸ˆì•¡:
    <input type="number" id="amount" placeholder="ê¸ˆì•¡ ì…ë ¥"/>
</label>

<br><br>

<button id="pay-button">ì£¼ë¬¸ ìƒì„± í›„ ê²°ì œí•˜ê¸°</button>

<br><br>

<label>
    ì£¼ë¬¸ë²ˆí˜¸(orderId):
    <input type="text" id="orderId" placeholder="ì£¼ë¬¸ë²ˆí˜¸(UUID) ì…ë ¥" />
</label>

<br><br>

<label>
    ì·¨ì†Œì‚¬ìœ (cancelReason):
    <input type="text" id="cancelReason" placeholder="ì·¨ì†Œì‚¬ìœ " />
</label>

<br><br>

<button id="refund-button">í™˜ë¶ˆ í•˜ê¸°</button>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            if (typeof globalThis.TossPayments !== 'function') {
                throw new TypeError('TossPayments is not defined.');
            }

            // HTML íŒŒì¼ë¡œ ê²°ì œ í…ŒìŠ¤íŠ¸ ì‹œ í´ë¼ì´ì–¸íŠ¸ í‚¤ ë°”ê¿” ì£¼ì„¸ìš”!

            // const clientKey = 'test_ck_0RnYX2w532qpnn7EPAAN8NeyqApQ';
            const clientKey = 'test_ck_ex6BJGQOVDke4JO2pWwR3W4w2zNb';
            const tossPayments = globalThis.TossPayments(clientKey);

            document.getElementById('pay-button').addEventListener('click', async function () {
                const amountInput = document.getElementById('amount').value;

                if (!amountInput || Number(amountInput) <= 0) {
                    alert("ê²°ì œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    return;
                }

                const amount = Number(document.getElementById("amount").value);
                const orderId = crypto.randomUUID();

                const payload = {
                    orderId: orderId,
                    amount: amount
                };

                try {
                    const response = await fetch('/api/points/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Member-Id': '3fa85f64-5717-4562-b3fc-2c963f66afa6' //ë‚˜ì¤‘ì— í† í°ìœ¼ë¡œ êµì²´
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    document.getElementById('result').textContent =
                        JSON.stringify(data, null, 2);

                } catch (error) {
                    document.getElementById('result').textContent =
                        'ê²°ì œ request ìƒì„± ì‹¤íŒ¨: ' + error;
                }

                tossPayments.requestPayment('ì¹´ë“œ', {
                    company: 'í† ìŠ¤í˜ì´',
                    orderId,
                    amount,
                    orderName: 'í…ŒìŠ¤íŠ¸ ìƒí’ˆ',
                    successUrl: 'http://localhost:8086/payments/success.html',
                    failUrl: 'http://localhost:8086/payments/fail.html'
                });
            });

        document.getElementById("refund-button").addEventListener("click", async () => {

        const orderId = document.getElementById("orderId").value;
        const cancelReason = document.getElementById("cancelReason").value;

        if (!orderId) {
            alert("orderIdë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        if (!cancelReason) {
            alert("ì·¨ì†Œì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const requestBody = {
            orderId: orderId,
            cancelReason: cancelReason
        };

        try {
            const response = await fetch("/api/points/refund", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Member-Id": '3fa85f64-5717-4562-b3fc-2c963f66afa6' // ğŸ”¥ ì‹¤ì œ memberId ë„£ê¸°
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                alert(error.message);
                return;
            }

            const result = await response.json();
            console.log(result);
            alert("í™˜ë¶ˆ ì„±ê³µ: " + JSON.stringify(result));

        } catch (e) {
            console.error(e);
            alert("í™˜ë¶ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    });

        } catch (error) {
            console.error('Toss ìœ„ì ¯ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            alert('Toss ìœ„ì ¯ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
        }
    });
</script>
</body>
</html>
