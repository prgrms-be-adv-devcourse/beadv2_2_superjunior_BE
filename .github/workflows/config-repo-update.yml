#file: noinspection SpellCheckingInspection
name: Config Repo Update
on:
  push:
    branches:
      - main
      - feature/ci-cd   # 테스트용
      - feature/ci-cd-*
    paths:
      - 'config/repo/*.yml'
      - '.github/workflows/config-repo-update.yml'  # 테스트용

jobs:
  update-configmap:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 변경된 파일 탐색
        id: changed-files
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD | grep 'config/repo/.*\.yml$' || echo "")
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed files:"
          echo "$CHANGED"

      - name: 설정 파일을 전달 받을 폴더 생성
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          port: 22
          script: |
            sudo rm -rf /tmp/config-repo
            mkdir -p /tmp/config-repo

      - name: 변경된 설정 파일을 EC2 인스턴스로 복사
        if: steps.changed-files.outputs.files != ''
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          port: 22
          source: "config/repo/*.yml"
          target: "/tmp/config-repo"
          strip_components: 2
          overwrite: true

      - name: ConfigMap 적용 후 필요한 Pod 재시작
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BASTION_HOST }}
          username: ${{ secrets.BASTION_USER }}
          key: ${{ secrets.BASTION_SSH_KEY }}
          port: 22
          command_timeout: '5m'
          script: |
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

            kubectl create configmap config-repo \
              --from-file=/tmp/config-repo/ \
              --dry-run=client -o yaml | kubectl apply -f -

            echo "ConfigMap updated successfully"

            kubectl rollout restart deployment/config-server
            echo "Waiting for config-server to be ready..."
            kubectl rollout status deployment/config-server --timeout=3m

            CHANGED_FILES="${{ steps.changed-files.outputs.files }}"

            if echo "$CHANGED_FILES" | grep -q "application.yml"; then
              echo "Common config changed, restarting all services..."
              kubectl rollout restart deployment/gateway-server
              kubectl rollout restart deployment/member-server
              kubectl rollout restart deployment/product-server
              kubectl rollout restart deployment/order-server
              kubectl rollout restart deployment/point-server
              kubectl rollout restart deployment/notification-server
              kubectl rollout restart deployment/search-server
            else
              echo "Restarting affected services only..."
              echo "$CHANGED_FILES" | grep -q "gateway.yml" && kubectl rollout restart deployment/gateway-server && echo "Gateway restarted" || true
              echo "$CHANGED_FILES" | grep -q "member.yml" && kubectl rollout restart deployment/member-server && echo "Member restarted" || true
              echo "$CHANGED_FILES" | grep -q "product.yml" && kubectl rollout restart deployment/product-server && echo "Product restarted" || true
              echo "$CHANGED_FILES" | grep -q "order.yml" && kubectl rollout restart deployment/order-server && echo "Order restarted" || true
              echo "$CHANGED_FILES" | grep -q "point.yml" && kubectl rollout restart deployment/point-server && echo "Point restarted" || true
              echo "$CHANGED_FILES" | grep -q "notification.yml" && kubectl rollout restart deployment/notification-server && echo "Notification restarted" || true
              echo "$CHANGED_FILES" | grep -q "elastic-search.yml" && kubectl rollout restart deployment/search-server && echo "Search restarted" || true
            fi

            rm -rf /tmp/config-repo

            echo "Config update completed!"
