#file: noinspection SpellCheckingInspection
name: Infra Pods Update
on:
  push:
    branches:
      - dev
      - feature/ci-cd-*test
    paths:
      - 'docs/k8s/infra/*.yml'
      - '!docs/k8s/infra/config.yml'
      - '!docs/k8s/infra/discovery.yml'
      - '.github/workflows/infra-pods-update.yml'

jobs:
  update-infra-pods:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 변경된 파일 탐색
        id: changed-files
        run: |
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'docs/k8s/infra/.*\.yml$' | grep -v 'docs/k8s/infra/config\.yml' | grep -v 'docs/k8s/infra/discovery\.yml' | tr '\n' ' ' || echo "")
          echo "files=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed files:"
          echo "$CHANGED"

      - name: Kubectl 설치
        if: steps.changed-files.outputs.changed == ''
        uses: azure/setup-kubectl@v3

      - name: Kubeconfig 설정
        if: steps.changed-files.outputs.changed == ''
        shell: bash
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: 변경된 Infra 리소스 적용
        if: steps.changed-files.outputs.files != ''
        shell: bash
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          echo "Applying changed infrastructure files..."
          
          for file in $CHANGED_FILES; do
          filename=$(basename "$file")
          if [ -f "/tmp/k8s-infra/$filename" ]; then
          echo "Applying $filename..."
          kubectl apply -f "/tmp/k8s-infra/$filename"
          echo "$filename applied successfully"
          fi
          done
          
          echo "Waiting for deployments to be ready..."
          
          if echo "$CHANGED_FILES" | grep -q "redis.yml"; then
          echo "Waiting for redis deployment..."
          kubectl rollout status deployment/redis --timeout=3m || true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "postgres.yml"; then
          echo "Waiting for postgres deployment..."
          kubectl rollout status deployment/postgres --timeout=3m || true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "kafka.yml"; then
          echo "Waiting for kafka deployment..."
          kubectl rollout status deployment/kafka --timeout=3m || true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "elastic-search.yml"; then
          echo "Waiting for elasticsearch deployment..."
          kubectl rollout status deployment/elasticsearch --timeout=3m || true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "logstash.yml"; then
          echo "Waiting for logstash deployment..."
          kubectl rollout status deployment/logstash --timeout=3m || true
          fi
          
          echo "Infrastructure update completed!"
